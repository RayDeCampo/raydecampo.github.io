<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    
    <title>Lab Notes by Ray DeCampo</title>
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />
    <link rel="stylesheet" href="/assets/css/prism.css?v=0078bf4d74eb76e1fdbb7162b26b4575c821735e">
    <link rel="stylesheet" href="/assets/css/theme.css?v=0078bf4d74eb76e1fdbb7162b26b4575c821735e">
    <link rel="stylesheet" href="/assets/css/style.css?v=0078bf4d74eb76e1fdbb7162b26b4575c821735e">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>
    <div class="wrapper">
      <header>
        <ul>
          <li><a href="/posts.html">Posts</a></li>
          <li><a href="/tags.html">Tags</a></li>
          <li><a href="/feeds/posts/default" title="RSS"><i class="svg-icon rss"></i> RSS</a></li>
          <li><a href="/about/">About</a></li>
        </ul>
        <h1 class="header"><a id="homelink" href="/">Lab Notes</a></h1>
        <p class="header">Things I want to remember how to do.</p>
      </header>

      <section>
        

<article class="post">
  <h1>Configuring Wildfly for JWT Authentication</h1>
  
  <div class="date">
    March 17, 2019
  </div>

  <div class="tags">
  
    <a href="/tags.html#WildFly">WildFly</a>
  
    <a href="/tags.html#JWT">JWT</a>
  
    <a href="/tags.html#JEE">JEE</a>
  
    <a href="/tags.html#CDI">CDI</a>
  
  </div>
  
  <div class="entry">
    <p>In this post we describe how to configure WildFly to access JSON Web Tokens (JWT) via the Authentication header using the Bearer schema.  This allows you to install stateless authenticated REST services on WildFly.</p>
<p><strong>NOTE:</strong> Another way to accomplish this is to use the KeyCloak server and install its components in your WildFly server.  For large deployments that is the better approach.  This approach is more suitable to a small deployment where KeyCloak would be overkill.</p>
<p>We adapt the instructions and code from <a href="https://github.com/wildfly/quickstart/tree/master/jaxrs-jwt">https://github.com/wildfly/quickstart/tree/master/jaxrs-jwt</a>.  This adaptation does not use a keystore but simply a pre-generated public/private key pair.  This reduces the complexity and positions our server better for cloud deployment (as their are no external files to access).</p>
<h2>Generate the keys</h2>
<p>First we generate a public/private key pair.  Note that you will be able to generate different key pairs for different environments (e.g. development, test, production).</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Use an empty passphrase when prompted</span><br>$ ssh-keygen -t rsa -b <span class="token number">4096</span> -m PEM -f jwtRS256.key<br>$ openssl rsa -in jwtRS256.key -pubout -outform PEM -out jwtRS256.key.pub<br><span class="token comment"># To see the private key:</span><br>$ <span class="token function">more</span> jwtRS256.key<br><span class="token comment"># To see the public key:</span><br>$ <span class="token function">more</span> jwtRS256.key.pub</code></pre>
<h2>Configure Wildfly</h2>
<p>Here we configure Wildfly to enforce the presence of a bearer token for secure application resources.  Start the WildFly admin command line interface:</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> <span class="token variable">$WILDFLY_HOME</span>/bin<br>./jboss-cli.sh --connect</code></pre>
<p>The remaining commands in this section are input for the WildFly admin CLI.</p>
<p>Add a new token security realm to elytron for authentication using JWTs, using the public key that was generated.  Replace the fake key below with the key from your <code>jwtRS256.key.pub</code> file:</p>
<pre class="language-none"><code class="language-none">    /subsystem=elytron/token-realm=jwt-realm:add( \<br>        jwt={ \<br>            issuer=["my-application-issuer"], \<br>            audience=["my-application-audience"], \<br>            public-key="-----BEGIN PUBLIC KEY-----<br>    AXaRqQL18r/NiUV7vpQyLvqjC34pLYF3l3mrpfeIG1bXATsqVmJkNhAkkIyjLcTA<br>    qB5a+lpWb08GtpkcLX7G2+s7Js05CngGv4wGHmp9yiO9z5nMIcQXQXtT41Qn6716<br>    DGbDiTBQ+xycByEXuM6hU25rTnlWfGCRigm0zSjg6716Qr4zsYT7NyQWb+K7ntvd<br>    cuYjOfSbhY0imX6TYU8Edv4YOJe2pBeteHV1UHYcwMBGjt661yWWhx6fwJQMIA+v<br>    rKh58z7Pi5mqr0rFTX9zDK1h79vygXNTAlZcRubVjEpa8fCgvYMrbqq1CC12j07d<br>    dHbCWv3cjoVcnmW4g6k4M6xLx6kpKcBbCDiaEalJ2o872GNMXqJYuFw7YmmQaskw<br>    sUZTJjhu7BgofU3/t01VAWe0ye2s9H0LzUuWNUx1YcKgpi0efGUB/2rmejfFTUr/<br>    1pbTTXTqxiuB3Jnt+dhA/XJX11ALo27Ngzto0nkC/2s0csGq7uqJ4Dt2bGBvs1jB<br>    DWo76frVXuVNJqJACuZ1eL2JKt12vu7c2an++UooHZDDcRGkbivf4wBycxJmdKpE<br>    nN0SQ9j42ldOVz708CGgbXTJCcaZ6gH0Hbm1d6v+vpZESmaKjUtvFI/gnFGCqqWM<br>    MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAxjYdscscXjbDb/kfnfXc<br>    7ZFoJOusLdXxfouD8WGy5oMCAwEAAQ==<br>    -----END PUBLIC KEY-----" \<br>        },principal-claim="sub")</code></pre>
<p>Add a new security domain, which uses the jwt security realm:</p>
<pre class="language-none"><code class="language-none">    /subsystem=elytron/security-domain=jwt-domain:add( \<br>        realms=[{ \<br>            realm=jwt-realm, \<br>            role-decoder=groups-to-roles \<br>        }],permission-mapper=default-permission-mapper, \<br>        default-realm=jwt-realm)</code></pre>
<p>Create http authentication factory that uses BEARER_TOKEN authentication:</p>
<pre class="language-none"><code class="language-none">    /subsystem=elytron/http-authentication-factory=jwt-http-authentication:add( \<br>        security-domain=jwt-domain, \<br>        http-server-mechanism-factory=global, \<br>        mechanism-configurations=[{ \<br>            mechanism-name="BEARER_TOKEN", \<br>            mechanism-realm-configurations=[{ \<br>                realm-name="jwt-realm" \<br>        }]}])</code></pre>
<p>Configure Undertow to use our http authentication factory for authentication:</p>
<pre class="language-none"><code class="language-none">    /subsystem=undertow/application-security-domain=other:add( \<br>        http-authentication-factory=jwt-http-authentication)</code></pre>
<h2>Configure the Web Application</h2>
<p>A few entries in the <code>web.xml</code> for your web application are required.</p>
<p>First, we put the private key (from your <code>jwtRS256.key</code> file) in an environment entry.  Your private key will be much longer than the fake one I have used here:</p>
<pre class="language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Private key for signing JWTs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-name</span><span class="token punctuation">></span></span>jwtPrivateKey<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-name</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-type</span><span class="token punctuation">></span></span>java.lang.String<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-type</span><span class="token punctuation">></span></span><br>        <span class="token comment">&lt;!-- The development key, use an overlay in production --></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-value</span><span class="token punctuation">></span></span><br>-----BEGIN RSA PRIVATE KEY-----<br>B73cQ1t2nx+0v6Fz7NcfhEbejyk02Kf+NJbKZPuZfnZlHSqH9xecxN2g1OYZtd0n<br>+Gg93QKCAQBd45hMMNohn6d+KkXRnNRkQLzVCQPMCHNAJL6773QPjeSskvvlXVOR<br>E2uxFupdP6qMV/oMHlm+XT6b/AeWma1o3oa6zvoEXx+dx+WTXjTHZEvTguZEcv7w<br>6l1T3bul5ujmK3DbHjfX77V3tDLYN0xQj6KZazRf9MQsZoC5xWKDLPGdfogS+1db<br>sr6Tq725Op4wRRwPDEYZthonddVyuMWrDElkC3HrK+31X+4wuP10gPdiayq2O3p8<br>NyCaimTtIELvLa32hJxsGQe8juTZ15quCmAu4tffmRdX3z1zFXoI6ObkM6hDhGWw<br>myHW4Qzjk6vijIYbeu7n5Tr77w8VSuh9AoIBAFhbLDJPmnC8Tp/BS5U2ntaxS8Qb<br>+icGXNguaHaw9niUCflHeWqaHYDNxGchnlFoEo5WxWuw0hC/peB2bjFLVFYif/mV<br>xUZfLBvKOUbeCor/m+jDoT19AQFpLu/at5Z82nLKyH3CqS4MO9VDs3PPZF6cbV89<br>fC2JD/k0MXuCRPa9t22v4BYBxG1AzcvTr/ly7pxNX8hoEHkNjx3e9ZrjyWa3pWFo<br>is4WSrogQVJHmCAceaTnUrSbfZ3SfAcElA/Qf94HQNrqIT5WetFy6INDdHD8WS61<br>wJMTAe2BezELmGR2NyBQp4IZrBEEtH03dBX9H61lm9raBId4Cc84C/mThes=<br>-----END RSA PRIVATE KEY-----<br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-value</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry</span><span class="token punctuation">></span></span></code></pre>
<p>Next we standard <code>security-constraint</code> and <code>login-config</code> entries.  Replace the <code>url-pattern</code> and <code>role-name</code> with appropriate values for your application.  The <code>url-pattern</code> determines which REST URLs are protected.  The <code>role-name</code> enforces a role for the user (you must have at least one role).  There is a lot of flexibity available here that we will not cover.  Also replace the <code>realm-name</code> and <code>web-resource-name</code> with appropriate values, although these are not referenced elsewhere.</p>
<pre class="language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>security-constraint</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-resource-collection</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-resource-name</span><span class="token punctuation">></span></span>Secure REST URLs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-resource-name</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/admin/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-resource-collection</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>auth-constraint</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role-name</span><span class="token punctuation">></span></span>administrator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>role-name</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>auth-constraint</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>security-constraint</span><span class="token punctuation">></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>login-config</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>auth-method</span><span class="token punctuation">></span></span>BEARER_TOKEN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>auth-method</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>realm-name</span><span class="token punctuation">></span></span>ACME Corp.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>realm-name</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>login-config</span><span class="token punctuation">></span></span></code></pre>
<h2>Authenticating Users</h2>
<p>In this section we present some Java snippets to demonstrate how to create and sign a JWT once your user is authenticated.  The code here uses Context and Dependency Injection (CDI), it is assumed you are familiar with it.</p>
<p>First, a simple CDI bean to read the private key from the JNDI environment:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Dependent</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtKey</span> <span class="token punctuation">{</span><br>    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"jwtPrivateKey"</span><span class="token punctuation">)</span><br>    <span class="token keyword">private</span> <span class="token class-name">String</span> privateKeyAsString<span class="token punctuation">;</span><br><br>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPrivateKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> privateKeyAsString<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Next we make a producer method for the <code>PrivateKey</code> instance:</p>
<pre class="language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> RSA_STRIP_REGEX <span class="token operator">=</span><br>        <span class="token string">"BEGIN RSA PRIVATE KEY|END RSA PRIVATE KEY|-|\\s"</span><span class="token punctuation">;</span><br><br>    <span class="token annotation punctuation">@Produces</span><br>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">PrivateKey</span> <span class="token function">producePrivateKey</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">JwtKey</span> jwtKey<span class="token punctuation">)</span><br>        <span class="token keyword">throws</span> <span class="token class-name">KeyStoreException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">GeneralSecurityException</span> <span class="token punctuation">{</span><br>        <span class="token keyword">final</span> <span class="token class-name">String</span> keyString <span class="token operator">=</span> jwtKey<span class="token punctuation">.</span><span class="token function">getPrivateKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">final</span> <span class="token class-name">String</span> base64Key <span class="token operator">=</span> keyString<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>RSA_STRIP_REGEX<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>base64Key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">final</span> <span class="token class-name">PKCS8EncodedKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">final</span> <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"RSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span></code></pre>
<p>Now the code to create the token using the <a href="https://connect2id.com/products/nimbus-jose-jwt">Nimbus + JOSE library</a>:</p>
<pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@Inject</span><br>    <span class="token keyword">private</span> <span class="token class-name">PrivateKey</span> privateKey<span class="token punctuation">;</span><br><br>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createJwt</span><span class="token punctuation">(</span><br>        <span class="token keyword">final</span> <span class="token class-name">String</span> subject<span class="token punctuation">,</span><br>        <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> roles<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JOSEException</span> <span class="token punctuation">{</span><br><br>        <span class="token keyword">final</span> <span class="token class-name">String</span> claims <span class="token operator">=</span> <span class="token class-name">Json</span><span class="token punctuation">.</span><span class="token function">createObjectBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"sub"</span><span class="token punctuation">,</span> subject<span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"iss"</span><span class="token punctuation">,</span> ISSUER<span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"aud"</span><span class="token punctuation">,</span> AUDIENCE<span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"groups"</span><span class="token punctuation">,</span> <span class="token class-name">Json</span><span class="token punctuation">.</span><span class="token function">createArrayBuilder</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"exp"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">+</span> EXPIRATION<span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">final</span> <span class="token class-name">JWSHeader</span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JWSHeader<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token class-name">JWSAlgorithm</span><span class="token punctuation">.</span>RS256<span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">JOSEObjectType</span><span class="token punctuation">.</span>JWT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">final</span> <span class="token class-name">JWSObject</span> jws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JWSObject</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Payload</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        jws<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RSASSASigner</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> jws<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span></code></pre>
<p>Finally we define a REST endpoint to send the token to the user:</p>
<pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@POST</span><br>    <span class="token annotation punctuation">@Path</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">)</span><br>    <span class="token annotation punctuation">@Consumes</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_FORM_URLENCODED<span class="token punctuation">)</span><br>    <span class="token keyword">public</span> <span class="token class-name">Response</span> <span class="token function">token</span><span class="token punctuation">(</span><br>        <span class="token annotation punctuation">@FormParam</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span><br>        <span class="token annotation punctuation">@FormParam</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>        <span class="token keyword">final</span> <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">Response<span class="token punctuation">.</span>Status</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> roles <span class="token operator">=</span> <span class="token function">getRolesForUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">final</span> <span class="token class-name">String</span> token <span class="token operator">=</span> jwtCreator<span class="token punctuation">.</span><span class="token function">createJwt</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">final</span> <span class="token class-name">JsonObject</span> response <span class="token operator">=</span> <span class="token class-name">Json</span><span class="token punctuation">.</span><span class="token function">createObjectBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"roles"</span><span class="token punctuation">,</span> <span class="token class-name">Json</span><span class="token punctuation">.</span><span class="token function">createArrayBuilder</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span></code></pre>
<h2>Client-side</h2>
<p>Just a few notes about the client-side.  You can authenticate the user by POSTing to the <code>token</code> endpoint and get back the token in the response.  Save the token in whatever mechanism is appropriate for your application.</p>
<p>Whenever accessing a protected URL, include the token using the standard <code>Authentication</code> header using the <code>Bearer</code> schema (see <a href="https://jwt.io/introduction/">https://jwt.io/introduction/</a> for more details).  If the token expires or is otherwise invalid, WildFly will return a <code>403 Forbidden</code> response.  At that point you can re-prompt the user for credentials and obtain a new token (or take whatever action is appropriate for your application).</p>
<h2>Configure Wildfly overlay</h2>
<p>As a final note, you may be concerned that the private key has been built into the war archive.  There is no need to have multiple builds for multiple environments however.  By using the <a href="http://docs.wildfly.org/13/Admin_Guide.html#Deployment_Overlays">WildFly overlay functionality</a>, combined with the override ability via <code>jboss-web.xml</code> we can replace the development private key with keys for each environment.</p>
<p>First, create <code>/path/to/overlay/jboss-web.xml</code> file containing the actual private key (obviously use a path that makes sense for your environment):</p>
<pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><br><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">jboss-web</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jboss-web</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Private key for signing JWTs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-name</span><span class="token punctuation">></span></span>jwtPrivateKey<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-name</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-type</span><span class="token punctuation">></span></span>java.lang.String<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-type</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env-entry-value</span><span class="token punctuation">></span></span><br>-----BEGIN RSA PRIVATE KEY-----<br>gXNTAlZcRubVjEpa8fCgvYMrbqq1CC12j07dDWo76frVXuVNJqJACuZ1eL2JKt12<br>vu7c2an++UooHZDDcRGkbivf4wBycxJmdKpEdHbCWv3cjoVcnmW4g6k4M6xLx6kp<br>KcBbCDiaEalJ2o872GNMXqJYuFw7YmmQaskwqB5a+lpWb08GtpkcLX7G2+s7Js05<br>CngGv4wGHmp9yiO9z5nMIcQXQXtT41Qn6716sUZTJjhu7BgofU3/t01VAWe0ye2s<br>9H0LzUuWNUx1YcKgpi0efGUB/2rmejfFTUr/1pbTTXTqxiuB3Jnt+dhA/XJX11AL<br>o27Ngzto0nkC/2s0csGq7uqJ4Dt2bGBvs1jBnN0SQ9j42ldOVz708CGgbXTJCcaZ<br>-----END RSA PRIVATE KEY-----<br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry-value</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env-entry</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jboss-web</span><span class="token punctuation">></span></span></code></pre>
<p>Then use the command line tool to associate the overlay to the deployment, replacing the <code>name</code>, the path to the overlay and the <code>deployments</code>:</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token builtin class-name">cd</span> <span class="token variable">$WILDFLY_HOME</span>/bin<br>$ ./jboss-cli.sh --connect<br>deployment-overlay <span class="token function">add</span> <span class="token punctuation">\</span><br>    --name<span class="token operator">=</span>myOverlay <span class="token punctuation">\</span><br>    --content<span class="token operator">=</span>/WEB-INF/web.xml<span class="token operator">=</span>/path/to/overlay/jboss-web.xml <span class="token punctuation">\</span><br>    --deployments<span class="token operator">=</span>my-war-file.war <span class="token punctuation">\</span><br>    --redeploy-affected</code></pre>
<h2>Resources</h2>
<ul>
<li><a href="https://jwt.io/introduction/">https://jwt.io/introduction/</a></li>
<li><a href="https://github.com/wildfly/quickstart/tree/master/jaxrs-jwt">https://github.com/wildfly/quickstart/tree/master/jaxrs-jwt</a></li>
<li><a href="http://docs.wildfly.org/13/Admin_Guide.html#Deployment_Overlays">http://docs.wildfly.org/13/Admin_Guide.html#Deployment_Overlays</a></li>
<li><a href="https://connect2id.com/products/nimbus-jose-jwt">https://connect2id.com/products/nimbus-jose-jwt</a></li>
</ul>

  </div>
</article>

      </section>

      <footer>
        <div>Ray DeCampo</div>
        <div>
          <a href="https://github.com/RayDeCampo" title="GitHub"><i class="svg-icon github"></i></a>
          <a href="https://twitter.com/iamdoingitwrong" title="Twitter"><i class="svg-icon twitter"></i></a>
          <a href="https://www.linkedin.com/in/raymonddecampo/" title="LinkedIn"><i class="svg-icon linkedin"></i></a>
        </div>
      </footer>
    </div>
  </body>
</html>
