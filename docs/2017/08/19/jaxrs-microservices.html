<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    
    <title>Lab Notes by Ray DeCampo</title>
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />
    <link rel="stylesheet" href="/assets/css/prism.css">
    <link rel="stylesheet" href="/assets/css/theme.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>
    <div class="wrapper">
      <header>
        <ul>
          <li><a href="/posts.html">Posts</a></li>
          <li><a href="/tags.html">Tags</a></li>
          <li><a href="/feeds/posts/default" title="RSS"><i class="svg-icon rss"></i> RSS</a></li>
          <li><a href="/about/">About</a></li>
        </ul>
        <h1 class="header"><a id="homelink" href="/">Lab Notes</a></h1>
        <p class="header">Things I want to remember how to do.</p>
      </header>

      <section>
        

<article class="post">
  <h1>JAX-RS Microservices</h1>
  
  <div class="date">
    August 19, 2017
  </div>

  <div class="tags">
  
    <a href="/tags.html#java">java</a>
  
    <a href="/tags.html#REST">REST</a>
  
    <a href="/tags.html#JAX-RS">JAX-RS</a>
  
    <a href="/tags.html#JEE">JEE</a>
  
    <a href="/tags.html#WildFly">WildFly</a>
  
    <a href="/tags.html#xirr">xirr</a>
  
    <a href="/tags.html#docker">docker</a>
  
    <a href="/tags.html#Node.js">Node.js</a>
  
    <a href="/tags.html#grunt">grunt</a>
  
    <a href="/tags.html#gotcha">gotcha</a>
  
    <a href="/tags.html#JavaScript">JavaScript</a>
  
    <a href="/tags.html#ES6">ES6</a>
  
    <a href="/tags.html#JSON">JSON</a>
  
    <a href="/tags.html#CORS">CORS</a>
  
  </div>
  
  <div class="entry">
    <p>An example project where we have taken a Java library (<a href="https://github.com/RayDeCampo/java-xirr">java-xirr</a>) and expose it as a REST service using JAX-RS.  Then the service is dockerized using the maven dockerfile plugin.  On the client side, we create a separate client using the Node.js connect server in order to illustrate various issues with CORS when utilizing REST services.</p>
<p>The project is available on GitHub as <a href="https://github.com/RayDeCampo/rest-xirr">rest-xirr</a>.</p>
<h2>The REST service</h2>
<h3>Configuration</h3>
<p>Turning a library into a REST service using JAX-RS in JEE 7 is pretty easy using the <code>@ApplicationPath</code>, <code>@Path</code>, <code>@GET</code> and <code>@POST</code> annotations,  This has been covered extensively elsewhere so I won't go into details here.</p>
<p>We want our REST service to use JSON to interact with the client, so we add <code>@Consumes</code> and <code>@Produces</code> annotations to our <code>XirrService.xirr()</code> method (<a href="https://github.com/RayDeCampo/rest-xirr/blob/63d284b800c16df35c67fff4c372d446f26a427e/server/src/main/java/org/decampo/rest/xirr/XirrService.java#L26">full source</a>):</p>
<pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@POST</span><br>    <span class="token annotation punctuation">@Consumes</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><br>    <span class="token annotation punctuation">@Produces</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><br>    <span class="token keyword">public</span> <span class="token class-name">XirrResult</span> <span class="token function">xirr</span><span class="token punctuation">(</span><span class="token class-name">TxRecord</span><span class="token punctuation">[</span><span class="token punctuation">]</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">try</span> <span class="token punctuation">{</span><br>            <span class="token comment">// Convert TxRecords into Transactions</span><br>            <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Transaction</span><span class="token punctuation">></span></span> tx <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">TxRecord</span><span class="token operator">::</span><span class="token function">toTransaction</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">final</span> <span class="token keyword">double</span> xirr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Xirr</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">xirr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token comment">// Wrap result in result object</span><br>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">XirrResult</span><span class="token punctuation">(</span>xirr<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> iae<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token comment">// Convert IAEs thrown by Xirr into ServiceExceptions for the</span><br>            <span class="token comment">// exception mapper</span><br>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span>iae<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span></code></pre>
<p>The JAX-RS implementation will handle consuming the JSON and converting it to an array of <code>TxRecord</code> instances.  It will also convert the return value, <code>XirrResult</code>, into JSON for the client.</p>
<h3>JSON Details</h3>
<p>Let's drill into the rest of the <code>xirr()</code> method.  First, you may notice that we are using a new class, <code>TxRecord</code> for the input instead of the <code>Transaction</code> class provided by the xirr library.  The reason for this is that the JSON deserializer provided by JAX-RS will not work with immutable classes.  So <code>TxRecord</code> is a mutable wrapper around <code>Transaction</code>.</p>
<p>For the return value, we could have just returned a <code>double</code>, and that would have been fine, but instead we created a wrapper object to see the JSON serialization in action.</p>
<h3>Error Handling</h3>
<p>Finally you might notice we are catching the <code>IllegalArgumentException</code>s thrown by the xirr library and converting them into a custom exception, <code>ServiceException</code>.  This allows us to define an <a href="https://docs.oracle.com/javaee/7/api/javax/ws/rs/ext/ExceptionMapper.html">ExceptionMapper</a> to handle the errors (<a href="https://github.com/RayDeCampo/rest-xirr/blob/63d284b800c16df35c67fff4c372d446f26a427e/server/src/main/java/org/decampo/rest/ServiceExceptionMapper.java#L13">full source</a>):</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Provider</span><br><span class="token annotation punctuation">@Singleton</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceExceptionMapper</span> <span class="token keyword">implements</span> <span class="token class-name">ExceptionMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceException</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span><br><br>    <span class="token annotation punctuation">@Override</span><br>    <span class="token keyword">public</span> <span class="token class-name">Response</span> <span class="token function">toResponse</span><span class="token punctuation">(</span><span class="token class-name">ServiceException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// Send the exception details to the client</span><br>        <span class="token comment">// A production version would probably use a custom error object</span><br>        <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">Response<span class="token punctuation">.</span>Status</span><span class="token punctuation">.</span>INTERNAL_SERVER_ERROR<span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br><span class="token punctuation">}</span></code></pre>
<p>The result is that when an IllegalArgumentException is thrown by the xirr library, it is converted in a <code>ServiceException</code> by the <code>XirrService</code> and then the above <code>ExceptionMapper</code> implementation kicks in.  So instead of the default HTML page served by WildFly when an exception is thrown, the client gets the JSON encoding of the exception.</p>
<p>Originally I had the <code>ExceptionMapper</code> implementation extending <code>ExceptionMapper&lt;Exception&gt;</code>, but that ended up being too broad.  When the client was sending the CORS preflight check (OPTIONS HTTP method), WildFly was throwing an exception in the process of generating the default OPTIONS reply required by the JAX-RS specfication.  Then there was an additional issue with the mapping and the end result was the preflight check always failed and the following stacktrace emitted:</p>
<pre><code>13:50:06,423 ERROR [io.undertow.request] (default task-52) UT005023: Exception handling request to /xirr: org.jboss.resteasy.spi.UnhandledException: org.jboss.resteasy.core.NoMessageBodyWriterFoundFailure: Could not find MessageBodyWriter for response object of type: org.jboss.resteasy.spi.DefaultOptionsMethodException of media type: application/octet-stream
	at org.jboss.resteasy.core.SynchronousDispatcher.writeException(SynchronousDispatcher.java:187)
	at org.jboss.resteasy.core.SynchronousDispatcher.invoke(SynchronousDispatcher.java:206)
	at org.jboss.resteasy.plugins.server.servlet.ServletContainerDispatcher.service(ServletContainerDispatcher.java:221)
	at org.jboss.resteasy.plugins.server.servlet.HttpServletDispatcher.service(HttpServletDispatcher.java:56)
	at org.jboss.resteasy.plugins.server.servlet.HttpServletDispatcher.service(HttpServletDispatcher.java:51)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)
// trimmed here for brevity
Caused by: org.jboss.resteasy.core.NoMessageBodyWriterFoundFailure: Could not find MessageBodyWriter for response object of type: org.jboss.resteasy.spi.DefaultOptionsMethodException of media type: application/octet-stream
	at org.jboss.resteasy.core.ServerResponseWriter.writeNomapResponse(ServerResponseWriter.java:66)
	at org.jboss.resteasy.core.SynchronousDispatcher.writeException(SynchronousDispatcher.java:183)
	... 42 more
</code></pre>
<h3>Dockerization</h3>
<p>Finally what microservice would be complete without a Docker image?  The <code>Dockerfile</code> is simple and uses WildFly as the application server, but there is no reason any other compliant server could not be used (<a href="https://github.com/RayDeCampo/rest-xirr/blob/63d284b800c16df35c67fff4c372d446f26a427e/server/Dockerfile">full source</a>):</p>
<pre class="language-docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> jboss/wildfly:latest</span><br><span class="token instruction"><span class="token keyword">ADD</span> target/*.war /opt/jboss/wildfly/standalone/deployments/</span></code></pre>
<p>The <a href="https://github.com/spotify/dockerfile-maven">dockerfile maven plugin</a> from Spotify has been integrated in order to convert the <code>Dockerfile</code> into an image.  If you want to build and run a Docker container for the service:</p>
<pre class="language-bash"><code class="language-bash">$ mvn clean <span class="token function">install</span> dockerfile:build<br>$ docker run -p <span class="token number">8080</span>:8080 --name xirr-rest decampo/xirr-rest:1.0.0-SNAPSHOT</code></pre>
<p>Note that in order for the dockerfile plugin to work you must have Docker listening on port 2375 over TCP.  If this is an issue of course the Docker image may still be built with the <code>docker</code> command as long as you have built the <code>xirr.war</code> first using Maven.</p>
<h4>Configuring Docker on Fedora</h4>
<p>This should probably be a separate post, but very quickly, let me describe how to configure Docker on Fedora to listen on port 2375.  This should not be done lightly however as it is a local system privlege escalation risk.</p>
<p>First, create or edit the <code>/etc/docker/daemon.json</code> file to contain:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>    <span class="token property">"hosts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"unix:///var/run/docker.sock"</span><span class="token punctuation">,</span> <span class="token string">"tcp://127.0.0.1:2375"</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre>
<p>Then in bash:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Create a docker group</span><br>$ <span class="token function">sudo</span> <span class="token function">groupadd</span> docker<br><span class="token comment"># Add yourself to the group</span><br>$ <span class="token function">sudo</span> gpasswd -a <span class="token variable">${<span class="token environment constant">USER</span>}</span> docker<br><span class="token comment"># Restart the docker service</span><br>$ <span class="token function">sudo</span> systemctl restart docker<br><span class="token comment"># Refresh your groups (or log out and log back in for GUI applications)</span><br>$ newgrp docker</code></pre>
<h3>Testing with curl</h3>
<p>Once the container is up and running we can test it with <code>curl</code>:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Test the ping service:</span><br>$ <span class="token function">curl</span> http://localhost:8080/xirr<br><br><span class="token comment"># Test the xirr service:</span><br>$ <span class="token function">curl</span> -H <span class="token string">"Content-type: application/json"</span> -X POST <span class="token punctuation">\</span><br>       -d <span class="token string">'[ { "amount":-1000, "when":"2017-01-01" }, <br>             { "amount": 1100, "when":"2018-01-01" } ]'</span> <span class="token punctuation">\</span><br>       http://localhost:8080/xirr/<br><br><span class="token comment"># Test the xirr service and force an error condition:</span><br>$ <span class="token function">curl</span> -H <span class="token string">"Content-type: application/json"</span> -X POST <span class="token punctuation">\</span><br>       -d <span class="token string">'[ { "amount": 1000, "when":"2017-01-01" }, <br>             { "amount": 1100, "when":"2018-01-01" } ]'</span> <span class="token punctuation">\</span><br>       http://localhost:8080/xirr/</code></pre>
<h2>REST Client</h2>
<p>We could have built the client inside the war for the service, but that's not a realistic scenario for actual deployment.  So instead we build a client that is served from a separate server and tries to contact the xirr REST service directly.  That puts us directly into the crosshairs of Cross-Origin Resource Sharing, aka <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">CORS</a>.</p>
<h3>CORS HTTP Headers</h3>
<p>Normally a web browser will not allow JavaScript code to connect to a server that did not serve that code for security reasons.  CORS is a scheme contocted by the browser makers to allow a server to indicate that it can accept connections from other domains.  Keep in mind that CORS is enforced on the client and thus you can't really rely on it to supply security for the server.</p>
<p>To allow arbitrary clients to connect to our xirr REST service, we need for it to satisfy a couple of requirements.  First, it should respond properly to requests made via the HTTP OPTIONS method.  As noted above, the JAX-RS specification requires the implementation to generate a proper response for OPTIONS requests if the application does not specify a different one.  So we are fine in that respect.</p>
<p>Second, the service needs to set a number of HTTP headers to specify the required security settings to the client.  For this we define a JAX-RS response filter which will be applied to every response from our service (<a href="https://github.com/RayDeCampo/rest-xirr/blob/63d284b800c16df35c67fff4c372d446f26a427e/server/src/main/java/org/decampo/rest/CorsHeadersFilter.java#L16">full source</a>):</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Provider</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CorsHeadersFilter</span> <span class="token keyword">implements</span> <span class="token class-name">ContainerResponseFilter</span> <span class="token punctuation">{</span><br><br>    <span class="token annotation punctuation">@Override</span><br>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">filter</span><span class="token punctuation">(</span><br>        <span class="token keyword">final</span> <span class="token class-name">ContainerRequestContext</span> requestContext<span class="token punctuation">,</span><br>        <span class="token keyword">final</span> <span class="token class-name">ContainerResponseContext</span> responseContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span><br>        <span class="token keyword">final</span> <span class="token class-name">MultivaluedMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> headers <span class="token operator">=</span><br>            responseContext<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token comment">// Following allows for all clients</span><br>        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Origin"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Headers"</span><span class="token punctuation">,</span> ALLOWED_HEADERS<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Credentials"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Methods"</span><span class="token punctuation">,</span> ALLOWED_METHODS<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token comment">// Set the length of time in seconds the preflight check may be cached</span><br>        <span class="token comment">// Use 1 second here for development purposes</span><br>        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Max-Age"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>The <code>@Provider</code> annotation indicates to JAX-RS that this should be used whenever a <code>ContainerResponseFilter</code> is needed.</p>
<p>In this case <code>ALLOWED_HEADERS</code> is <code>&quot;Authorization, Content-Type&quot;</code>.  You may include any header you want, including custom headers.  If a header is included in the request that is not whitelisted, the request is disallowed (by the browser).  A list of automatically whitelisted headers is available at <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header">https://fetch.spec.whatwg.org/#cors-safelisted-request-header</a>.</p>
<p>For <code>ALLOWED_METHODS</code>, I've used <code>&quot;DELETE, GET, HEAD, OPTIONS, POST, PUT&quot;</code>.</p>
<p>We can test out the CORS configuration using <code>curl</code>:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Test preflight request</span><br>$ <span class="token function">curl</span> -i -X OPTIONS http://localhost:8080/xirr<br><br><span class="token comment"># Test headers on normal request:</span><br>$ <span class="token function">curl</span> -D - http://localhost:8080/xirr</code></pre>
<h3>Simple Node.js web server</h3>
<p>For hosting the REST client, we use a simple Node.js web server, <a href="https://github.com/senchalabs/connect">connect</a> and run it using <a href="https://gruntjs.com">grunt</a> via the <a href="https://github.com/gruntjs/grunt-contrib-connect">grunt-contrib-connect</a> plugin (<a href="https://github.com/RayDeCampo/rest-xirr/blob/63d284b800c16df35c67fff4c372d446f26a427e/client/Gruntfile.js">full source of Gruntfile.js</a>):</p>
<pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">grunt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token string">'use strict'</span><span class="token punctuation">;</span><br>    <br>    grunt<span class="token punctuation">.</span><span class="token function">loadNpmTasks</span><span class="token punctuation">(</span><span class="token string">'grunt-contrib-connect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <br>    grunt<span class="token punctuation">.</span><span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Simple HTTP server to host the xirr client</span><br>    <span class="token comment">// Runs on port 8000 by default</span><br>    grunt<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>        options<span class="token operator">:</span> <span class="token punctuation">{</span><br>            base<span class="token operator">:</span> <span class="token string">'www'</span><span class="token punctuation">,</span><br>            keepalive<span class="token operator">:</span> <span class="token boolean">true</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token string">'default'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Then the client server (ugh, server for the client?) can be started with the command <code>grunt connect</code>.  By using the <code>keepalive</code> option the server will continue to run.</p>
<h3>JavaScript REST Client</h3>
<p>For the JavaScript REST Client an ES6 class is created, <code>XirrClient</code>.  A class method is created corresponding to the two service methods on the <code>XirrService</code> Java class, <code>ping()</code> and <code>xirr()</code>.</p>
<p>The <code>ping()</code> method uses <code>fetch()</code> (see <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch">Using Fetch</a> from MDN for more details) in it's simplest form (<a href="https://github.com/RayDeCampo/rest-xirr/blob/63d284b800c16df35c67fff4c372d446f26a427e/client/www/js/XirrClient.js#L37">full source</a>):</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8080/xirr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span></code></pre>
<p>The <code>fetch()</code> method returns a <code>Promise</code> object with a <code>Response</code> payload.  The <code>ping()</code> method converts that into a <code>Promise</code> with a string payload for the caller.</p>
<p>The <code>xirr()</code> method uses <code>fetch()</code> in a more complicated way, since we need to deliver a JSON payload via POST for the xirr REST endpoint (<a href="https://github.com/RayDeCampo/rest-xirr/blob/63d284b800c16df35c67fff4c372d446f26a427e/client/www/js/XirrClient.js#L50">full source</a>):</p>
<pre class="language-javascript"><code class="language-javascript">    <span class="token function">xirr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8080/xirr'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>            method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span><br>            headers<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <br>            body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>txs<span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span></code></pre>
<p>Note that using this form of <code>fetch()</code> allows us to send custom headers, including, if desired, an <code>Authentication</code> header for Open ID.</p>
<p>Another interesting aspect of this is the <code>Promise</code> returned by <code>fetch()</code> does not reject based on the HTTP status code of the response.  In other words, when status code 500 is returned by our xirr REST service because of invalid input, we still end up in the normal success handler.</p>
<p>In this case we convert the <code>Promise</code> payload into the parsed JSON object returned by the server.  So the <code>xirr()</code> method will return an object with a <code>xirr</code> property on success and a <code>message</code> property (from the serialized exception) when the xirr throws an <code>IllegalArgumentException</code>.</p>
<p>You can see the client in action in the <code>index.js</code> file (<a href="https://github.com/RayDeCampo/rest-xirr/blob/63d284b800c16df35c67fff4c372d446f26a427e/client/www/index.js#L24">full source</a>):</p>
<pre class="language-javascript"><code class="language-javascript">    client<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"2017-01-01"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> <span class="token number">1100</span><span class="token punctuation">,</span> <span class="token string">"2018-01-01"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">xirr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'output'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <br>            result<span class="token punctuation">.</span>xirr <span class="token operator">?</span> formatter<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>xirr<span class="token punctuation">)</span> <span class="token operator">:</span> result<span class="token punctuation">.</span>message<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>errorHandler<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2>Summary</h2>
<p>So, we have covered quite a bit here.  Probably should have been a couple of blog posts, but in the end everything is so cross-referenced I felt it works better as a whole.</p>
<p>We wrapped a Java library with REST using JAX-RS and then dockerized the result.  The REST service was configured to allow for CORS requests.  Then we created a client from browser-based JavaScript land which consumes the service.</p>
<h2>Resources</h2>
<ul>
<li><a href="https://docs.oracle.com/javaee/7/api/">JEE 7 API</a></li>
<li><a href="https://github.com/spotify/dockerfile-maven">Dockerfile Maven plugin</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API documentation on MDN</a></li>
<li><a href="https://fetch.spec.whatwg.org/">Fetch specification</a></li>
<li><a href="https://github.com/gruntjs/grunt-contrib-connect">Grunt connect plugin</a></li>
<li><a href="https://github.com/RayDeCampo/rest-xirr">https://github.com/RayDeCampo/rest-xirr</a></li>
<li><a href="https://github.com/RayDeCampo/java-xirr">https://github.com/RayDeCampo/java-xirr</a></li>
<li><a href="https://www.youtube.com/watch?v=tgpruknOOfE">Build To Last From Frontend To Backend slideless talk by Adam Bien</a></li>
</ul>

  </div>
</article>

      </section>

      <footer>
        <div>Ray DeCampo</div>
        <div>
          <a href="https://github.com/RayDeCampo" title="GitHub"><i class="svg-icon github"></i></a>
          <a href="https://twitter.com/iamdoingitwrong" title="Twitter"><i class="svg-icon twitter"></i></a>
          <a href="https://www.linkedin.com/in/raymonddecampo/" title="LinkedIn"><i class="svg-icon linkedin"></i></a>
        </div>
      </footer>
    </div>
  </body>
</html>
